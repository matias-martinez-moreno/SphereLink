{% extends 'organizations/superadmin_base.html' %}
{% load static %}

{% block title %}CSV Bulk Invite - SphereLink{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">CSV Bulk User Invitation</h2>
                    <p class="text-muted">Upload a CSV file to invite multiple users to an organization at once</p>
                    {% if preselected_org %}
                    <div class="alert alert-info py-2 mt-2">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Organization preselected</strong> - You can change it in the form below if needed
                    </div>
                    {% endif %}
                </div>
                <a href="{% url 'organizations:organization_list' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Back to Organizations
                </a>
            </div>

            <!-- Instructions Card -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>Instructions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h6>CSV File Requirements:</h6>
                            <ul class="mb-3">
                                <li>File must have a <code>.csv</code> extension</li>
                                <li>Email addresses should be in the <strong>first column</strong></li>
                                <li>One email address per row</li>
                                <li>File size must be less than 5MB</li>
                                <li>Empty rows will be skipped</li>
                            </ul>
                            
                            <h6>What happens during processing:</h6>
                            <ul class="mb-0">
                                <li>‚úÖ Valid emails will create new user accounts</li>
                                <li>üîÑ Existing users will be added to the selected organization</li>
                                <li>‚ùå Invalid emails will be skipped and reported</li>
                                <li>‚ö†Ô∏è Users already in the organization will be skipped</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6>Sample CSV Format:</h6>
                            <div class="bg-light p-3 rounded">
                                <code>
                                    john.doe@eafit.edu.co<br>
                                    maria.garcia@eafit.edu.co<br>
                                    student123@eafit.edu.co<br>
                                    professor.smith@eafit.edu.co
                                </code>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload Form -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-cloud-upload me-2"></i>Upload CSV File
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.organization.id_for_label }}" class="form-label">
                                        <strong>Target Organization</strong>
                                    </label>
                                    {{ form.organization }}
                                    <div class="form-text">{{ form.organization.help_text }}</div>
                                    {% if form.organization.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.organization.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.default_role.id_for_label }}" class="form-label">
                                        <strong>Default Role</strong>
                                    </label>
                                    {{ form.default_role }}
                                    <div class="form-text">{{ form.default_role.help_text }}</div>
                                    {% if form.default_role.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.default_role.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.csv_file.id_for_label }}" class="form-label">
                                <strong>CSV File</strong>
                            </label>
                            {{ form.csv_file }}
                            <div class="form-text">{{ form.csv_file.help_text }}</div>
                            {% if form.csv_file.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in form.csv_file.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-upload me-2"></i>Process CSV File
                            </button>
                            <button type="reset" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle me-2"></i>Reset Form
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Results Display -->
            {% if results %}
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-check-circle me-2"></i>Processing Results
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="display-6 text-success">{{ results.successful_invites }}</div>
                                <small class="text-muted">Successfully Invited</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="display-6 text-warning">{{ results.existing_users }}</div>
                                <small class="text-muted">Already in Organization</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="display-6 text-danger">{{ results.invalid_emails }}</div>
                                <small class="text-muted">Invalid Emails</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="display-6 text-secondary">{{ results.total_processed }}</div>
                                <small class="text-muted">Total Processed</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>Summary:</strong> 
                        {{ results.successful_invites }} users were successfully invited to 
                        <strong>{{ results.organization.name }}</strong> with the role of 
                        <strong>{{ results.default_role|title }}</strong>.
                    </div>
                    
                    {% if results.errors %}
                    <div class="mt-4">
                        <h6>Issues Encountered:</h6>
                        <div class="alert alert-warning">
                            <ul class="mb-0">
                                {% for error in results.errors %}
                                <li>{{ error }}</li>
                                {% endfor %}
                                {% if results.errors|length == 20 %}
                                <li><em>... and more (showing first 20 errors only)</em></li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="mt-4">
                        <a href="{% url 'organizations:manage_user_roles' results.organization.id %}" class="btn btn-primary">
                            <i class="bi bi-people me-2"></i>View Organization Users
                        </a>
                        <a href="{% url 'organizations:csv_bulk_invite' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-repeat me-2"></i>Invite More Users
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.card-header {
    border: none;
    font-weight: 500;
}

.btn {
    border-radius: 8px;
    font-weight: 500;
}

.form-control, .form-select {
    border-radius: 8px;
    border: 2px solid #e9ecef;
}

.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.display-6 {
    font-weight: 600;
}

code {
    background-color: #f8f9fa;
    padding: 2px 4px;
    border-radius: 4px;
    font-size: 0.9em;
}
</style>
{% endblock %}